
\chapter{Object Files}

Wa, ha, ha.

\section{ELF Header}

\subsection{Machine Information}

For file identification in \texttt{e_ident}, the \xARCH architecture
requires the following values.

\begin{table}[H]
\Hrule
  \caption{\xARCH Identification}
  \begin{center}
    \begin{tabular}[t]{l|l}
      \multicolumn{1}{c}{Position} & \multicolumn{1}{c}{Value} \\
      \hline
      \texttt{e_ident[EI_CLASS]} & \texttt{ELFCLASS64} \\
      \texttt{e_ident[EI_DATA]} & \texttt{ELFDATA2LSB}
    \end{tabular}
  \end{center}
\Hrule
\end{table}

Processor identification resides in the ELF header's
\texttt{e_machine} member and must have the value
\texttt{EM_X8664}.\footnote{The value of this identifier is 62.}

\section{Sections}

No changes required.

\section{Symbol Table}

No changes required.

\section{Relocation}

\subsection{Relocation Types}

The \xARCH ABI adds one additional field:

\begin{figure}[H]
\Hrule
  \caption{Relocatable Fields}
\begin{center}
  \begin{picture}(300,100)
    \put(0,66){\framebox(150, 33){31\hfill\textit{word32}\hfill 0}}
    \put(0,0){\framebox(300, 33){63\hfill\textit{word64}\hfill 0}}
  \end{picture}
\end{center}
\Hrule
\end{figure}

\noindent
\begin{tabular*}{\textwidth}{l@{\extracolsep{\fill}}p{4in}}
\textit{word32} & This specifies a 32-bit field occupying 4 bytes
                  with arbitrary byte alignment.  These values use
                  the same byte order as other word values in the
                  \xARCH architecture. \\
\textit{word64} & This specifies a 64-bit field occupying 8 bytes
                  with arbitrary byte alignment.  These values use
                  the same byte order as other word values in the
                  \xARCH architecture. \\
\end{tabular*}

The \xARCH ABI architectures uses only \texttt{Elf64_Rel} relocation
entries.

\begin{figure}[H]
\Hrule
  \caption{Relocation Types}
  \begin{center}
    \begin{tabular}[t]{l|r|l|l}
      \multicolumn{1}{c}{Name} & 
      \multicolumn{1}{c}{Value} & 
      \multicolumn{1}{c}{Field} & 
      \multicolumn{1}{c}{Calculation} \\
      \hline
      \texttt{R_X8664_NONE}  & 0 & none & none \\
      \texttt{R_X8664_64}    & 1 & \textit{word64} & \texttt{S + A} \\
      \texttt{R_X8664_PC32}  & 2 & \textit{word32} & \texttt{S + A - P} \\
      \texttt{R_X8664_GOT32} & 3 & \textit{word32} & \texttt{G + A} \\
      \texttt{R_X8664_PLT64} & 4 & \textit{word64} & \texttt{L + A - P} \\
      \texttt{R_X8664_COPY}  & 5 & none            & none \\
      \texttt{R_X8664_GLOB_DAT} & 6 & \textit{word64} & \texttt{S} \\
      \texttt{R_X8664_JMP_SLOT} & 7 & \textit{word64} & \texttt{S} \\
      \texttt{R_X8664_RELATIVE} & 8 & \textit{word64} & \texttt{B + A} \\
      \texttt{R_X8664_GOTPCREL} & 9 & \textit{word64} & \texttt{G + GOT + A - P} \\
    \end{tabular}
  \end{center}
\Hrule
\end{figure}

The special semantics for these relocation types are identical to
those used for the Intel386 architecture.
\footnote{Even though the \xARCH architecture supports IP-relative
  addressing modes, a GOT is still required since the address from
  a particular instruction to a particular data item cannot be
  known by the static linker.}
\footnote{Note that the \xARCH architecture assumes that offsets into
  GOT are 32-bit values, not 64-bit values.  This choice means that a
  maximum of $2^{32}/8 = 2^{29}$ entries can be placed in the GOT.
  However, that should be more than enough for most programs.  In the
  event that it is not enough, the linker could create multiple GOTs.
  Because 32-bit offsets are used, loads of global data do not require
  loading the offset into a displacement register; the base plus
  immediate displacement addressing form can be used.}

The \texttt{R_X8664_GOTPC} relocation has different semantics from the
\texttt{R_I386_GOTPC} relocation.  In particular, because the \xARCH
architecture has an addressing mode relative to the instruction
pointer, it is possible to load an address from the GOT using a single
instruction.  The calculation done by the \texttt{R_X8664_GOTPC}
relocation gives the difference between the location in the GOT where
the symbol's address is given and the location where the relocation is
applied.

%%% Local Variables: 
%%% mode: latex
%%% TeX-master: "abi"
%%% End: 
